{% extends "base.html" %}

{% block title %}Dashboard - Event Management Platform{% endblock %}

{% block content %}
<div id="dashboard-content">
    <div class="spinner"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function() {
        const token = localStorage.getItem('access_token');
        
        if (!token) {
            console.log('No token found, redirecting to login...');
            window.location.href = '/login';
            return;
        }
        
        // Determine which dashboard to show based on user type
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        // If we have user data in localStorage, try to use it first
        if (user && user.user_type) {
            console.log('Using cached user data, redirecting...');
            if (user.user_type === 'organizer' || user.user_type === 'admin') {
                window.location.href = '/dashboard/organizer';
            } else {
                window.location.href = '/dashboard/attendee';
            }
            return;
        }
        
        // Fetch user profile to get current user type
        console.log('Fetching user profile...');
        fetch('/api/auth/profile', {
            headers: {
                'Authorization': 'Bearer ' + token
            }
        })
        .then(response => {
            if (!response.ok) {
                if (response.status === 401) {
                    // Token is invalid
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('user');
                    window.location.href = '/login';
                    return null;
                }
                throw new Error('Failed to get user profile: ' + response.status);
            }
            return response.json();
        })
        .then(userData => {
            if (!userData) return; // Already handled redirect
            
            console.log('User profile fetched:', userData);
            localStorage.setItem('user', JSON.stringify(userData));
            
            // Redirect to appropriate dashboard based on user type
            if (userData.user_type === 'organizer' || userData.user_type === 'admin') {
                window.location.href = '/dashboard/organizer';
            } else {
                window.location.href = '/dashboard/attendee';
            }
        })
        .catch(error => {
            console.error('Error fetching user:', error);
            localStorage.removeItem('access_token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        });
    })();
</script>
{% endblock %}

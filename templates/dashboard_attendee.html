{% extends "base.html" %}

{% block title %}My Dashboard - Event Management Platform{% endblock %}

{% block content %}
<div class="dashboard container">
    <div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1>My Dashboard</h1>
            <p>Welcome back, <span id="user-name"></span>!</p>
        </div>
        <button onclick="logout()" class="btn btn-danger" style="height: fit-content; padding: 0.75rem 1.5rem; font-size: 1rem; cursor: pointer;">
            ğŸšª Logout
        </button>
    </div>

    <!-- Quick Actions -->
    <div class="card mb-4">
        <h2 class="card-header">Quick Actions</h2>
        <div class="grid grid-2">
            <a href="/events" class="btn btn-primary" style="text-align: center; text-decoration: none; display: block; padding: 1rem;">
                ğŸ” Browse Events
            </a>
            <a href="#my-orders" class="btn btn-success" style="text-align: center; text-decoration: none; display: block; padding: 1rem;">
                ğŸ« My Tickets
            </a>
        </div>
    </div>

    <!-- My Orders -->
    <div class="card">
        <h2 class="card-header">My Orders</h2>
        <div id="my-orders">
            <div class="spinner"></div>
        </div>
    </div>

    <!-- Upcoming Events -->
    <div class="card mt-4">
        <h2 class="card-header">Upcoming Events</h2>
        <div id="upcoming-events">
            <div class="spinner"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const token = localStorage.getItem('access_token');
    
    if (!token) {
        alert('Please login to access the dashboard');
        window.location.href = '/login';
        throw new Error('No token');
    }
    
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    if (user && user.first_name) {
        document.getElementById('user-name').textContent = user.first_name;
    } else {
        // Fetch user profile if not in localStorage
        fetch('/api/auth/profile', {
            headers: {
                'Authorization': 'Bearer ' + token
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to get user profile');
            }
            return response.json();
        })
        .then(userData => {
            localStorage.setItem('user', JSON.stringify(userData));
            document.getElementById('user-name').textContent = userData.first_name || 'User';
        })
        .catch(error => {
            console.error('Error fetching user:', error);
            localStorage.removeItem('access_token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        });
    }
    
    // Load orders
    fetch('/api/orders', {
        headers: {
            'Authorization': 'Bearer ' + token
        }
    })
    .then(response => {
        if (!response.ok) {
            if (response.status === 401) {
                localStorage.removeItem('access_token');
                localStorage.removeItem('user');
                window.location.href = '/login';
                return null;
            }
            throw new Error('Failed to fetch orders');
        }
        return response.json();
    })
    .then(orders => {
        if (!orders) return; // Already handled redirect
        
        // Load orders table
        document.getElementById('my-orders').innerHTML = orders.length > 0 ? `
            <table class="table">
                <thead>
                    <tr>
                        <th>Order Number</th>
                        <th>Event</th>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${orders.map(order => `
                        <tr>
                            <td>${order.order_number}</td>
                            <td>${order.event ? order.event.event_name : 'N/A'}</td>
                            <td>${new Date(order.created_at).toLocaleDateString()}</td>
                            <td>$${order.total_amount}</td>
                            <td><span style="padding: 0.25rem 0.5rem; border-radius: 0.25rem; background: ${order.status === 'completed' ? '#d1fae5' : order.status === 'pending' ? '#fef3c7' : '#fee2e2'}; color: ${order.status === 'completed' ? '#065f46' : order.status === 'pending' ? '#92400e' : '#991b1b'};">${order.status}</span></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        ` : '<p class="text-center">No orders yet. <a href="/events" class="btn btn-primary">Browse events</a> to get started!</p>';
    })
    .catch(error => {
        console.error('Error loading orders:', error);
        document.getElementById('my-orders').innerHTML = '<p class="text-center">Error loading orders. Please refresh the page.</p>';
    });
    
    // Load upcoming events
    fetch('/api/events?status=published', {
        headers: {
            'Authorization': 'Bearer ' + token
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to fetch events');
        }
        return response.json();
    })
    .then(events => {
        const now = new Date();
        const upcoming = events
            .filter(e => new Date(e.start_datetime) > now)
            .sort((a, b) => new Date(a.start_datetime) - new Date(b.start_datetime))
            .slice(0, 6);
        
        document.getElementById('upcoming-events').innerHTML = upcoming.length > 0 ? `
            <div class="grid grid-3">
                ${upcoming.map(event => `
                    <div class="event-card" onclick="window.location.href='/events/${event.event_id}'">
                        <div class="event-image">
                            ${event.banner_image ? `<img src="${event.banner_image}" alt="Banner" style="width:100%; height:100%; object-fit:cover;">` : 'ğŸµ'}
                        </div>
                        <div class="event-content">
                            <div class="event-title">${event.event_name}</div>
                            <div class="event-meta">
                                ğŸ“… ${new Date(event.start_datetime).toLocaleDateString()}<br>
                                ğŸ“ ${event.venue ? (event.venue.venue_name + ', ' + event.venue.city) : 'TBA'}
                            </div>
                            <div class="btn btn-primary" style="width: 100%;">View Event</div>
                        </div>
                    </div>
                `).join('')}
            </div>
        ` : '<p class="text-center">No upcoming events at the moment.</p>';
    })
    .catch(error => {
        console.error('Error loading upcoming events:', error);
        document.getElementById('upcoming-events').innerHTML = '<p class="text-center">Error loading events. Please refresh the page.</p>';
    });
</script>
{% endblock %}

